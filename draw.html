<script>
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const errorElement = document.getElementById("error");
  let drawing = false;
  let points = [];

  function drawSmileTemplate() {
    ctx.beginPath();
    ctx.strokeStyle = "#ddd";
    ctx.lineWidth = 4;
    ctx.arc(150, 120, 50, 0, Math.PI, false);
    ctx.stroke();
  }

  drawSmileTemplate();

  function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    points = [];
    drawSmileTemplate();
    errorElement.textContent = "";
    document.getElementById("reason").value = "";
  }

  function getTouchPos(evt) {
    const rect = canvas.getBoundingClientRect();
    return {
      x: evt.touches[0].clientX - rect.left,
      y: evt.touches[0].clientY - rect.top
    };
  }

  // Mouse Events
  canvas.addEventListener("mousedown", e => {
    drawing = true;
    ctx.beginPath();
    ctx.moveTo(e.offsetX, e.offsetY);
  });

  canvas.addEventListener("mousemove", e => {
    if (!drawing) return;
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 3;
    ctx.lineCap = "round";
    ctx.stroke();
    points.push({ x: e.offsetX, y: e.offsetY });
  });

  canvas.addEventListener("mouseup", () => drawing = false);
  canvas.addEventListener("mouseout", () => drawing = false);

  // Touch Events
  canvas.addEventListener("touchstart", e => {
    drawing = true;
    const pos = getTouchPos(e);
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
    e.preventDefault();
  });

  canvas.addEventListener("touchmove", e => {
    if (!drawing) return;
    const pos = getTouchPos(e);
    ctx.lineTo(pos.x, pos.y);
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 3;
    ctx.lineCap = "round";
    ctx.stroke();
    points.push({ x: pos.x, y: pos.y });
    e.preventDefault();
  });

  canvas.addEventListener("touchend", () => drawing = false);

  function validateSmile() {
    const reasonInput = document.getElementById("reason").value.trim();
    errorElement.innerHTML = ""; // Clear any old messages

    // Smile shape detection
    const smileZone = points.filter(p =>
      p.y >= 100 && p.y <= 140 && p.x >= 80 && p.x <= 220
    );
    const leftSide = points.some(p => p.x < 120 && p.y > 100);
    const rightSide = points.some(p => p.x > 180 && p.y > 100);

    if (smileZone.length < 15 || !leftSide || !rightSide) {
      errorElement.innerHTML = "âš ï¸ That doesn't look like a smile. Try to follow the gray arc.";
      return;
    }

    if (!reasonInput.toLowerCase().startsWith("i am happy because")) {
      errorElement.innerHTML = "âš ï¸ Please start with: I am happy because...";
      return;
    }

    // ðŸŽ‰ Celebration
    const confetti = "ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰";
    errorElement.innerHTML = `${confetti}<br><strong>Well done!</strong><br><br>Click below to add your smile:`;

    document.getElementById("confettiSound").play();

    const btn = document.createElement("button");
    btn.textContent = "Thank You";
    btn.onclick = () => {
      let count = parseInt(localStorage.getItem("weeklySmileCount") || 0);
      localStorage.setItem("weeklySmileCount", count + 1);
      document.body.innerHTML = `
        <div style="text-align: center; padding: 30px;">
          <h1 style="color: green;">ðŸŽ‰âœ… Your smile has been added to the weekly smile count. ðŸ˜Š</h1>
          <p><a href="index.html" style="text-decoration: underline;">Return to Home</a></p>
        </div>
      `;
    };

    errorElement.appendChild(document.createElement("br"));
    errorElement.appendChild(btn);
  }
</script>
