<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const countdown = document.getElementById("countdown");
  const message = document.getElementById("message");
  const hand = document.getElementById("hand");

  let smilingSeconds = 0;
  let count = 3;

  const compliments = [
    "You're glowing today! ‚ú®",
    "That smile could light up a room! üåü",
    "You look amazing when you smile üòç",
    "Smiling suits you so well üòä",
    "That‚Äôs the spirit! Keep shining!"
  ];

  navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    video.srcObject = stream;
  });

  const countdownInterval = setInterval(() => {
    count--;
    if (count === 0) {
      document.querySelector("h2").textContent = "Smile now! üòÅ";
      clearInterval(countdownInterval);
      startSmileDetection(); // Start smile check
    } else {
      countdown.textContent = count;
    }
  }, 1000);

  function startSmileDetection() {
    const interval = setInterval(() => {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const base64Image = canvas.toDataURL("image/jpeg");

      fetch('https://myapp-xn74.onrender.com/detect-smile', {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ image: base64Image })
      })
        .then(res => res.json())
        .then(data => {
          console.log("üòÑ SMILE API RESPONSE:", data);

          if (data.success && data.message.includes("beautiful")) {
            smilingSeconds++;
            hand.textContent = `üñê ${smilingSeconds}`;
            message.textContent = `Keep smiling... ${smilingSeconds}s`;

            if (smilingSeconds >= 10) {
              clearInterval(interval);
              hand.textContent = "üëè";
              message.innerHTML = `üéâ ${compliments[Math.floor(Math.random() * compliments.length)]}`;
              setTimeout(() => {
                let count = parseInt(localStorage.getItem("weeklySmileCount") || 0);
                localStorage.setItem("weeklySmileCount", count + 1);
                window.location.href = "done.html";
              }, 3000);
            }
          } else {
            smilingSeconds = 0;
            hand.textContent = "";
            message.textContent = "Try for a real smile üòê";
          }
        })
        .catch(err => {
          console.error("‚ùå Smile Detection Error:", err);
          message.textContent = "Error detecting smile.";
          clearInterval(interval);
        });
    }, 1000);
  }
</script>
