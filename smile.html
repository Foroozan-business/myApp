<script>
  const video = document.getElementById('video');
  const countdown = document.getElementById('countdown');
  const canvas = document.createElement('canvas');
  canvas.width = 320;
  canvas.height = 240;
  const ctx = canvas.getContext('2d');

  let smileDuration = 0;
  let detecting = true;

  const compliments = [
    "You're glowing today! ✨",
    "That smile could light up a room! 🌟",
    "You look amazing when you smile 😍",
    "Smiling suits you so well 😊",
    "That’s the spirit! Keep shining!"
  ];

  // Add canvas to body so it's ready (can be hidden via CSS)
  canvas.style.display = "none";
  document.body.appendChild(canvas);

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      video.srcObject = stream;
    })
    .catch(err => {
      countdown.textContent = "Cannot access camera 😢";
      console.error("Camera error:", err);
    });

  function detectSmile() {
    if (!detecting) return;

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const image = canvas.toDataURL('image/jpeg');

    fetch('https://myapp-xn74.onrender.com/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success && data.message.includes("beautiful")) {
        smileDuration++;
        countdown.textContent = `Smiling... ${smileDuration}/10`;

        if (smileDuration >= 10) {
          detecting = false; // stop further checks
          const compliment = compliments[Math.floor(Math.random() * compliments.length)];
          localStorage.setItem("lastSmileMessage", compliment);
          let count = parseInt(localStorage.getItem("weeklySmileCount") || 0);
          localStorage.setItem("weeklySmileCount", count + 1);
          window.location.href = "done.html";
        }
      } else {
        countdown.textContent = "Smile lost! Restarting...";
        smileDuration = 0;
      }
    })
    .catch(err => {
      console.error("Smile detection error:", err);
      countdown.textContent = "Error detecting smile.";
    });
  }

  setInterval(detectSmile, 1000);
</script>
