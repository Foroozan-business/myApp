<script>
  const video = document.getElementById('video');
  const countdown = document.getElementById('countdown');
  const canvas = document.createElement('canvas');
  canvas.width = 320;
  canvas.height = 240;
  const ctx = canvas.getContext('2d');
  let smileDuration = 0;

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      video.srcObject = stream;
    });

  function detectSmile() {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const image = canvas.toDataURL('image/jpeg');

    fetch('https://myapp-xn74.onrender.com/detect-smile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success && data.message.includes("beautiful")) {
        smileDuration++;
        countdown.textContent = `Smiling... ${smileDuration}/10`;
      } else {
        countdown.textContent = "Smile lost! Restarting...";
        smileDuration = 0;
      }

      if (smileDuration >= 10) {
        let count = parseInt(localStorage.getItem("weeklySmileCount") || 0);
        localStorage.setItem("weeklySmileCount", count + 1);
        window.location.href = "done.html";
      }
    })
    .catch(err => {
      console.error("Smile detection error:", err);
      countdown.textContent = "Error detecting smile.";
    });
  }

  setInterval(detectSmile, 1000);
</script>
