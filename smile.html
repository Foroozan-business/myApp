<script>
  const video = document.getElementById('video');
  const countdown = document.getElementById('countdown');
  const canvas = document.createElement('canvas');
  canvas.width = 320;
  canvas.height = 240;
  const ctx = canvas.getContext('2d');
  let smileDuration = 0;

  const compliments = [
    "You're glowing today! âœ¨",
    "That smile could light up a room! ðŸŒŸ",
    "You look amazing when you smile ðŸ˜",
    "Smiling suits you so well ðŸ˜Š",
    "Thatâ€™s the spirit! Keep shining!"
  ];

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      video.srcObject = stream;
    })
    .catch(err => {
      countdown.textContent = "Cannot access camera ðŸ˜¢";
      console.error("Camera error:", err);
    });

  function detectSmile() {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const image = canvas.toDataURL('image/jpeg');

    fetch('https://myapp-xn74.onrender.com/', { // âœ… using root instead of /detect-smile
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success && data.message.includes("beautiful")) {
        smileDuration++;
        countdown.textContent = `Smiling... ${smileDuration}/10`;

        if (smileDuration >= 10) {
          const compliment = compliments[Math.floor(Math.random() * compliments.length)];
          localStorage.setItem("lastSmileMessage", compliment);
          let count = parseInt(localStorage.getItem("weeklySmileCount") || 0);
          localStorage.setItem("weeklySmileCount", count + 1);
          window.location.href = "done.html";
        }
      } else {
        countdown.textContent = "Smile lost! Restarting...";
        smileDuration = 0;
      }
    })
    .catch(err => {
      console.error("Smile detection error:", err);
      countdown.textContent = "Error detecting smile.";
    });
  }

  setInterval(detectSmile, 1000);
</script>
